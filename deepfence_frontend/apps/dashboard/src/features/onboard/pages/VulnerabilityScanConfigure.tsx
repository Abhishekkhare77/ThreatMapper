import { cloneDeepWith } from 'lodash-es';
import { useEffect, useState } from 'react';
import { Button, Checkbox, Switch, Typography } from 'ui-components';

import { ConnectorHeader } from '@/features/onboard/components/ConnectorHeader';
import { usePageNavigation } from '@/utils/usePageNavigation';

const packages = [
  {
    name: 'OS Packages',
    checked: false,
  },
  {
    name: 'Java',
    checked: false,
  },
  {
    name: 'Javascript',
    checked: false,
  },
  {
    name: 'Rust',
    checked: false,
  },
  {
    name: 'GoLang',
    checked: false,
  },
  {
    name: 'Ruby',
    checked: false,
  },
  {
    name: 'Python',
    checked: false,
  },
  {
    name: 'PHP',
    checked: false,
  },
  {
    name: 'Dotnet',
    checked: false,
  },
];

export const VulnerabilityScanConfigure = () => {
  const { goBack } = usePageNavigation();
  const [isSelectAll, setIsSelectAll] = useState(false);
  const [pkgs, setSelectPackages] = useState(packages);

  useEffect(() => {
    if (isSelectAll) {
      const newPkgs = pkgs.map((pkg) => {
        pkg.checked = true;
        return pkg;
      });
      setSelectPackages(newPkgs);
    }
  }, [isSelectAll]);

  // select all switch
  const onSwitchChange = (checked: boolean) => {
    setIsSelectAll(checked);
    if (!checked) {
      const newPkgs = pkgs.map((pkg) => {
        pkg.checked = false;
        return pkg;
      });
      setSelectPackages(newPkgs);
    }
  };

  // packages checkbox
  const onPackageCheckedChange = (
    pkg: {
      name: string;
      checked: boolean;
    },
    checked: boolean,
  ) => {
    if (checked === false) {
      setIsSelectAll(false);
    } else if (pkgs.filter((pkg) => pkg.checked === true).length === pkgs.length - 1) {
      setIsSelectAll(true);
    }
    setSelectPackages((state) => {
      const _newState = cloneDeepWith(state, (value) => {
        if (value.name === pkg.name) {
          return {
            ...value,
            checked,
          };
        }
        return undefined;
      });

      return _newState;
    });
  };
  return (
    <>
      <ConnectorHeader
        title="Configure Vulnerability Scan"
        description="Choose from the below options to perform your first scan."
        metadata={{
          accountId: '234HTY6643',
          type: 'Host',
        }}
      />
      <section>
        <div className="flex">
          <h6
            className={`${Typography.size.lg} ${Typography.weight.medium} mt-0 dark:text-white`}
          >
            Packages
          </h6>
          <Button size="sm" color="primary" className="ml-auto">
            Start Scan
          </Button>
        </div>
        <div className="mt-4">
          <Switch
            label="Select All"
            size="sm"
            onCheckedChange={onSwitchChange}
            checked={isSelectAll}
          />
        </div>

        <div className="flex flex-row mt-4 gap-5">
          {pkgs.map((pkg) => {
            return (
              <Checkbox
                label={pkg.name}
                key={pkg.name}
                checked={isSelectAll ? true : pkg.checked}
                onCheckedChange={(checked: boolean) => {
                  onPackageCheckedChange(pkg, checked);
                }}
              />
            );
          })}
        </div>
      </section>

      <section className="mt-8">
        <h6
          className={`${Typography.size.lg} ${Typography.weight.medium} mt-4 dark:text-white`}
        >
          Advanced Options
        </h6>

        <div className="flex flex-col mt-4 gap-4">
          <Checkbox
            label={
              'Scan Entire Cluster (All hosts and container images of all pods in the cluster)'
            }
          />
          <Checkbox label={'Priority Scan'} />
        </div>
      </section>
      <Button onClick={goBack} color="default" size="xs" className="mt-16">
        Go Back
      </Button>
    </>
  );
};
