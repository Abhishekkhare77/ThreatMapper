import cx from 'classnames';
import { RefObject, useState } from 'react';
import { FaExpandAlt } from 'react-icons/fa';
import { HiChevronDown } from 'react-icons/hi';
import { IconContext } from 'react-icons/lib';
import { MdCopyAll } from 'react-icons/md';
import { Form } from 'react-router-dom';
import { Badge, ModalHeader, SlidingModal } from 'ui-components';

import { DFLink } from '@/components/DFLink';
import { VulnerabilityIcon } from '@/components/sideNavigation/icons/Vulnerability';
import { DagreGraphAttackPath } from '@/features/vulnerabilities/components/unique-vulnerabilities/DagreGraphAttackPath';

interface FocusableElement {
  focus(options?: FocusOptions): void;
}

const Urls = [
  'http://packetstormsecurity.com/files/165225/Apache-Log4j2-2.14.1-Remote-Code-Execution.html',
  'http://packetstormsecurity.com/files/165260/VMware-Security-Advisory-2021-0028.html',
  'http://packetstormsecurity.com/files/165261/Apache-Log4j2-2.14.1-Information-Disclosure.html',
  'http://packetstormsecurity.com/files/165270/Apache-Log4j2-2.14.1-Remote-Code-Execution.html',
  'http://packetstormsecurity.com/files/165281/Log4j2-Log4Shell-Regexes.html',
  'http://packetstormsecurity.com/files/165282/Log4j-Payload-Generator.html',
  'http://packetstormsecurity.com/files/165306/L4sh-Log4j-Remote-Code-Execution.html',
  'http://packetstormsecurity.com/files/165307/Log4j-Remote-Code-Execution-Word-Bypassing.html',
  'http://packetstormsecurity.com/files/165311/log4j-scan-Extensive-Scanner.html',
  'http://packetstormsecurity.com/files/165371/VMware-Security-Advisory-2021-0028.4.html',
  'http://packetstormsecurity.com/files/165532/Log4Shell-HTTP-Header-Injection.html',
  'http://packetstormsecurity.com/files/165642/VMware-vCenter-Server-Unauthenticated-Log4Shell-JNDI-Injection-Remote-Code-Execution.html',
  'http://packetstormsecurity.com/files/165673/UniFi-Network-Application-Unauthenticated-Log4Shell-Remote-Code-Execution.html',
  'http://packetstormsecurity.com/files/167794/Open-Xchange-App-Suite-7.10.x-Cross-Site-Scripting-Command-Injection.html',
  'http://packetstormsecurity.com/files/167917/MobileIron-Log4Shell-Remote-Command-Execution.html',
  'http://seclists.org/fulldisclosure/2022/Jul/11',
  'http://seclists.org/fulldisclosure/2022/Mar/23',
  'http://www.openwall.com/lists/oss-security/2021/12/10/1',
  'http://www.openwall.com/lists/oss-security/2021/12/10/2',
  'http://www.openwall.com/lists/oss-security/2021/12/10/3',
  'http://www.openwall.com/lists/oss-security/2021/12/13/1',
  'http://www.openwall.com/lists/oss-security/2021/12/13/2',
  'http://www.openwall.com/lists/oss-security/2021/12/14/4',
  'http://www.openwall.com/lists/oss-security/2021/12/15/3',
  'https://access.redhat.com/security/cve/CVE-2021-44228',
  'https://cert-portal.siemens.com/productcert/pdf/ssa-397453.pdf',
  'https://cert-portal.siemens.com/productcert/pdf/ssa-479842.pdf',
  'https://cert-portal.siemens.com/productcert/pdf/ssa-661247.pdf',
  'https://cert-portal.siemens.com/productcert/pdf/ssa-714170.pdf',
  'https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-44228',
  'https://github.com/advisories/GHSA-7rjr-3q55-vv33',
  'https://github.com/advisories/GHSA-jfh8-c2jp-5v3q',
  'https://github.com/apache/logging-log4j2/commit/c77b3cb39312b83b053d23a2158b99ac7de44dd3',
  'https://github.com/apache/logging-log4j2/pull/608',
  'https://github.com/apache/logging-log4j2/pull/608#issuecomment-990494126',
  'https://github.com/cisagov/log4j-affected-db',
  'https://github.com/cisagov/log4j-affected-db/blob/develop/SOFTWARE-LIST.md',
  'https://github.com/nu11secur1ty/CVE-mitre/tree/main/CVE-2021-44228',
  'https://github.com/tangxiaofeng7/apache-log4j-poc',
  'https://issues.apache.org/jira/browse/LOG4J2-3198',
  'https://issues.apache.org/jira/browse/LOG4J2-3201',
  'https://issues.apache.org/jira/browse/LOG4J2-3214',
  'https://issues.apache.org/jira/browse/LOG4J2-3221',
  'https://lists.debian.org/debian-lts-announce/2021/12/msg00007.html',
  'https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/M5CSVUNV4HWZZXGOKNSK6L7RPM7BOKIB/',
  'https://lists.fedoraproject.org/archives/list/package-announce@lists.fedoraproject.org/message/VU57UJDCFIASIO35GC55JMKSRXJMCDFM/',
  'https://logging.apache.org/log4j/2.x/changes-report.html#a2.15.0',
  'https://logging.apache.org/log4j/2.x/manual/lookups.html#JndiLookup',
  'https://logging.apache.org/log4j/2.x/manual/migration.html',
  'https://logging.apache.org/log4j/2.x/security.html',
  'https://msrc-blog.microsoft.com/2021/12/11/microsofts-response-to-cve-2021-44228-apache-log4j2/',
  'https://nvd.nist.gov/vuln/detail/CVE-2021-44228',
  'https://psirt.global.sonicwall.com/vuln-detail/SNWLID-2021-0032',
  'https://security.netapp.com/advisory/ntap-20211210-0007/',
  'https://support.apple.com/kb/HT213189',
  'https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-apache-log4j-qRuKNEbd',
  'https://twitter.com/kurtseifried/status/1469345530182455296',
  'https://ubuntu.com/security/notices/USN-5192-1',
  'https://ubuntu.com/security/notices/USN-5192-2',
  'https://ubuntu.com/security/notices/USN-5197-1',
  'https://wiki.ubuntu.com/SecurityTeam/KnowledgeBase/Log4Shell',
  'https://www.bentley.com/en/common-vulnerability-exposure/be-2022-0001',
  'https://www.debian.org/security/2021/dsa-5020',
  'https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00646.html',
  'https://www.kb.cert.org/vuls/id/930724',
  'https://www.lunasec.io/docs/blog/log4j-zero-day/',
  'https://www.nu11secur1ty.com/2021/12/cve-2021-44228.html',
  'https://www.oracle.com/security-alerts/alert-cve-2021-44228.html',
  'https://www.oracle.com/security-alerts/cpuapr2022.html',
  'https://www.oracle.com/security-alerts/cpujan2022.html',
];

const Header = () => {
  const severity = 'critical';

  return (
    <ModalHeader>
      <div className="flex flex-col w-full p-4">
        <div className="flex gap-x-2 items-center">
          <span className="w-5 h-5 text-gray-500 dark:text-white">
            <VulnerabilityIcon />
          </span>
          <span className="text-sm text-gray-900 dark:text-white">CVE-2-22-234</span>
          <Badge
            label={severity}
            className={cx({
              'bg-red-100 dark:bg-red-600/10 text-red-600 dark:text-red-400':
                severity.toLocaleLowerCase() === 'critical',
              'bg-pink-100 dark:bg-pink-600/10 text-pink-600 dark:text-pink-400':
                severity.toLocaleLowerCase() === 'high',
              'bg-blue-100 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400':
                severity.toLocaleLowerCase() === 'medium',
              'bg-yellow-300/20 dark:bg-yellow-400/10 text-yellow-500 dark:text-yellow-400':
                severity.toLocaleLowerCase() === 'low',
            })}
            size="sm"
          />
        </div>
        <span className="font-normal text-xs text-gray-400 ml-7">Seen 6 month ago</span>
        <div className="ml-6 mt-4">
          <button
            className={cx(
              'flex items-center gap-x-1 text-xs px-2 py-1 rounded-lg',
              'bg-gray-100 dark:bg-gray-800',
              'dark:text-white',
              'outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700',
            )}
          >
            <MdCopyAll />
            Copy as json
          </button>
        </div>
      </div>
    </ModalHeader>
  );
};

const DetailsComponent = () => {
  const [openDetails, setOpenDetails] = useState(true);
  const [openTopFiveAttackPath, setOpenTopFiveAttackPath] = useState(true);
  const [showUrls, setShowAllUrls] = useState(false);
  const severity = 'critical';
  return (
    <div>
      <section>
        <button
          className="flex mb-2 font-medium text-xs w-full"
          onClick={() => {
            setOpenDetails(!openDetails);
          }}
        >
          <span className="tracking-wider">DETAILS</span>
          <IconContext.Provider
            value={{
              className: cx('h-4 w-4 text-gray-600 dark:text-gray-200 ml-auto', {
                'rotate-0': openDetails === true,
                '-rotate-90': openDetails === false,
              }),
            }}
          >
            <HiChevronDown />
          </IconContext.Provider>
        </button>
        {openDetails ? (
          <>
            <p className="text-xs pr-2 text-gray-900 dark:text-gray-300 mb-2">
              Apache Log4j2 2.0-beta9 through 2.15.0 (excluding security releases 2.12.2,
              2.12.3, and 2.3.1) JNDI features used in...
              <p className="mt-2">
                <DFLink
                  to="https://www.oracle.com/security-alerts/cpujan2022.html"
                  className="text-blue-600 dark:text-blue-500"
                >
                  https://www.oracle.com/security-alerts/cpujan2022.html
                </DFLink>
              </p>
            </p>
            <div className="grid grid-cols-3 gap-2 items-center my-4">
              <div
                className={cx('flex flex-col', 'p-2 w-fit rounded-lg items-center', {
                  'bg-red-100 dark:bg-red-600/10 text-red-600 dark:text-red-400':
                    severity.toLocaleLowerCase() === 'critical',
                  'bg-pink-100 dark:bg-pink-600/10 text-pink-600 dark:text-pink-400':
                    severity.toLocaleLowerCase() === 'high',
                  'bg-blue-100 dark:bg-blue-600/10 text-blue-600 dark:text-blue-400':
                    severity.toLocaleLowerCase() === 'medium',
                  'bg-yellow-300/20 dark:bg-yellow-400/10 text-yellow-500 dark:text-yellow-400':
                    severity.toLocaleLowerCase() === 'low',
                })}
              >
                10
                <span className="text-gray-500 dark:text-gray-400 text-xs text-[10px]">
                  CVSS score
                </span>
              </div>
              <div className="flex flex-col text-xs text-gray-900 dark:text-white">
                <span>deepfence-poc-agent-2</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Host name
                </span>
              </div>

              <div className="flex flex-col text-xs text-gray-900 dark:text-white">
                <span>deepfence-poc-agent-2</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Image name
                </span>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-2 items-center my-4 text-xs text-gray-900 dark:text-white">
              <div className="flex flex-col">
                <span>deepfence-poc-agent-2</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Caused by package
                </span>
              </div>

              <div className="flex flex-col">
                <span>home/ubuntu/apache-log4j-2.14.1-bin/log4j-core-2.14.1.jar</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Caused by package path
                </span>
              </div>
              <div className="flex flex-col">
                <span>deepfence-poc-agent-2</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Fixed in
                </span>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-2 items-center my-4 text-xs text-gray-900 dark:text-white">
              <div className="flex flex-col">
                <span>-</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Container name
                </span>
              </div>

              <div className="flex flex-col">
                <span>-</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Kubernetes cluster name
                </span>
              </div>
            </div>

            <div className="grid grid-cols-3 gap-2 items-center my-4 text-xs text-gray-900 dark:text-white">
              <div className="flex flex-col">
                <span>Java</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">Type</span>
              </div>

              <div className="flex flex-col">
                <span>Host</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Node type
                </span>
              </div>
              <div className="flex flex-col">
                <span>False</span>
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Masked
                </span>
              </div>
            </div>

            <div className="flex flex-col gap-y-4 rounded-lg text-xs text-gray-900 dark:text-white">
              <div className="flex flex-col">
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Attack vector
                </span>
                <span>CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H</span>
              </div>

              <div className="flex flex-col">
                <span className="text-gray-500 dark:text-gray-400 text-[10px]">
                  Exploit poc
                </span>
                <span>
                  https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/multi/http/vmware_vcenter_log4shell.rb
                </span>
              </div>
              <div className="flex flex-col text-xs text-gray-900 dark:text-white">
                <button
                  className="text-gray-500 dark:text-gray-400 flex items-center gap-x-2"
                  onClick={() => {
                    setShowAllUrls(!showUrls);
                  }}
                >
                  <span className="text-[10px]">Urls</span>
                  <IconContext.Provider
                    value={{
                      className: cx(
                        'cursor-pointer h-2.5 w-2.5 text-gray-500 dark:text-gray-400',
                        {
                          'rotate-45': showUrls,
                        },
                      ),
                    }}
                  >
                    <FaExpandAlt />
                  </IconContext.Provider>
                </button>
                {!showUrls ? (
                  <>
                    <div>[</div>
                    <div className="pl-4">{Urls[0]}</div>
                    <div className="pl-4">...</div>
                    <div>]</div>
                  </>
                ) : (
                  <>
                    <div>[</div>
                    <div className="pl-4">{Urls.toString()}</div>
                    <div>]</div>
                  </>
                )}
              </div>
            </div>
          </>
        ) : null}
      </section>
      <section>
        <button
          className="flex mb-2 mt-4 font-medium text-xs w-full"
          onClick={() => {
            setOpenTopFiveAttackPath(!openTopFiveAttackPath);
          }}
        >
          <span className="tracking-wider">TOP 5 ATTACK PATHS</span>
          <IconContext.Provider
            value={{
              className: cx('h-4 w-4 text-gray-600 dark:text-gray-200 ml-auto', {
                'rotate-0': openTopFiveAttackPath === true,
                '-rotate-90': openTopFiveAttackPath === false,
              }),
            }}
          >
            <HiChevronDown />
          </IconContext.Provider>
        </button>
        {openTopFiveAttackPath ? (
          <div className="min-h-[200px] flex items-center justify-center">
            <DagreGraphAttackPath />
          </div>
        ) : null}
      </section>
    </div>
  );
};

export const VulnerabilityDetails = ({
  showDetails,
  elementToFocusOnClose,
  setShowFilter,
}: {
  elementToFocusOnClose: RefObject<FocusableElement> | null;
  showDetails: boolean;
  setShowFilter: React.Dispatch<React.SetStateAction<boolean>>;
}) => {
  return (
    <SlidingModal
      header={<Header />}
      open={showDetails}
      onOpenChange={() => setShowFilter(false)}
      elementToFocusOnCloseRef={elementToFocusOnClose}
      width={'w-2/6'}
    >
      <Form className="p-4">
        <DetailsComponent />
      </Form>
    </SlidingModal>
  );
};
