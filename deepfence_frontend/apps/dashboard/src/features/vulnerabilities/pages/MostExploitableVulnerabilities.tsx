import cx from 'classnames';
import { capitalize } from 'lodash-es';
import { Suspense, useMemo, useRef } from 'react';
import { IconContext } from 'react-icons';
import { FiFilter } from 'react-icons/fi';
import { HiChevronRight, HiExternalLink } from 'react-icons/hi';
import {
  Form,
  LoaderFunctionArgs,
  Outlet,
  useLoaderData,
  useNavigation,
  useSearchParams,
} from 'react-router-dom';
import {
  Badge,
  Breadcrumb,
  BreadcrumbLink,
  Checkbox,
  CircleSpinner,
  createColumnHelper,
  IconButton,
  Listbox,
  ListboxOption,
  Popover,
  Table,
  TableSkeleton,
} from 'ui-components';

import { getSearchApiClient } from '@/api/api';
import { ModelVulnerability, SearchSearchNodeReq } from '@/api/generated';
import { DFLink } from '@/components/DFLink';
import { FilterHeader } from '@/components/forms/FilterHeader';
import { VulnerabilityIcon } from '@/components/sideNavigation/icons/Vulnerability';
import { TruncatedText } from '@/components/TruncatedText';
import { apiWrapper } from '@/utils/api';
import { typedDefer, TypedDeferredData } from '@/utils/router';
import { DFAwait } from '@/utils/suspense';

type LoaderDataType = {
  error?: string;
  message?: string;
  data: Awaited<ReturnType<typeof getVulnerability>>;
};

const PAGE_SIZE = 15;

const getSeveritySearch = (searchParams: URLSearchParams) => {
  return searchParams.getAll('severity');
};
const getLiveConnectionSearch = (searchParams: URLSearchParams) => {
  return searchParams.getAll('liveConnection');
};

async function getVulnerability(searchParams: URLSearchParams): Promise<{
  vulnerabilities: Array<ModelVulnerability>;
  message?: string;
}> {
  const results: {
    vulnerabilities: Array<ModelVulnerability>;
    message?: string;
  } = {
    vulnerabilities: [],
  };

  const severity = getSeveritySearch(searchParams);
  const liveConnection = getLiveConnectionSearch(searchParams);

  const searchVulnerabilitiesRequestParams: SearchSearchNodeReq = {
    node_filter: {
      filters: {
        contains_filter: { filter_in: { exploitability_score: [1, 2, 3] } },
        order_filter: {
          order_fields: [
            {
              size: 1000,
              field_name: 'exploitability_score',
              descending: true,
            },
            {
              descending: true,
              field_name: 'cve_cvss_score',
            },
          ],
        },
        match_filter: { filter_in: {} },
        compare_filter: null,
      },
      in_field_filter: null,
      window: {
        offset: 0,
        size: 0,
      },
    },
    window: { offset: 0, size: 1000 },
  };

  const searchVulnerabilitiesApi = apiWrapper({
    fn: getSearchApiClient().searchVulnerabilities,
  });
  const searchVulnerabilitiesResponse = await searchVulnerabilitiesApi({
    searchSearchNodeReq: searchVulnerabilitiesRequestParams,
  });

  if (!searchVulnerabilitiesResponse.ok) {
    throw searchVulnerabilitiesResponse.error;
  }

  results.vulnerabilities = searchVulnerabilitiesResponse.value;

  if (severity?.length || liveConnection?.length) {
    results.vulnerabilities = results.vulnerabilities.filter((v) => {
      let match = true;
      if (severity.length && !severity.includes(v.cve_severity)) {
        match = false;
      }
      if (
        liveConnection.length &&
        !liveConnection.includes(v.has_live_connection ? 'active' : 'inActive')
      ) {
        match = false;
      }
      return match;
    });
  }

  return results;
}
const loader = async ({
  request,
}: LoaderFunctionArgs): Promise<TypedDeferredData<LoaderDataType>> => {
  const searchParams = new URL(request.url).searchParams;

  return typedDefer({
    data: getVulnerability(searchParams),
  });
};

const MostExploitableVulnerabilities = () => {
  const [searchParams, setSearchParams] = useSearchParams();
  const navigation = useNavigation();
  const columnHelper =
    createColumnHelper<LoaderDataType['data']['vulnerabilities'][number]>();
  const loaderData = useLoaderData() as LoaderDataType;

  const columns = useMemo(() => {
    const columns = [
      columnHelper.accessor('cve_id', {
        enableResizing: true,
        cell: (info) => (
          <DFLink
            to={{
              pathname: `./${info.getValue()}`,
              search: searchParams.toString(),
            }}
            className="flex items-center gap-x-2"
          >
            <>
              <div className="p-2 bg-gray-100 dark:bg-gray-500/10 rounded-lg">
                <div className="w-4 h-4">
                  <VulnerabilityIcon />
                </div>
              </div>
              {info.getValue()}
            </>
          </DFLink>
        ),
        header: () => 'CVE ID',
        minSize: 100,
        size: 150,
        maxSize: 250,
      }),
      columnHelper.accessor('cve_caused_by_package', {
        cell: (info) => info.getValue(),
        header: () => 'Package',
        minSize: 100,
        size: 120,
        maxSize: 125,
      }),
      columnHelper.accessor('cve_severity', {
        enableResizing: false,
        sortingFn: (rowA, rowB) => {
          const severityA = rowA.original.cve_severity?.toLowerCase() || 'default';
          const severityB = rowB.original.cve_severity?.toLowerCase() || 'default';
          const severityMap: { [key: string]: number } = {
            critical: 4,
            high: 3,
            medium: 2,
            low: 1,
            unknown: 0,
            default: 0,
          };
          return severityMap[severityA] - severityMap[severityB];
        },
        cell: (info) => (
          <Badge
            label={info.getValue().toUpperCase()}
            className={cx({
              'bg-[#de425b]/20 dark:bg-[#de425b]/20 text-[#de425b] dark:text-[#de425b]':
                info.getValue().toLowerCase() === 'critical',
              'bg-[#f58055]/20 dark:bg-[#f58055/20 text-[#f58055] dark:text-[#f58055]':
                info.getValue().toLowerCase() === 'high',
              'bg-[#ffd577]/30 dark:bg-[##ffd577]/10 text-yellow-400 dark:text-[#ffd577]':
                info.getValue().toLowerCase() === 'medium',
              'bg-[#d6e184]/20 dark:bg-[#d6e184]/10 text-yellow-300 dark:text-[#d6e184]':
                info.getValue().toLowerCase() === 'low',
              'bg-[#9CA3AF]/10 dark:bg-[#9CA3AF]/10 text-gray-400 dark:text-[#9CA3AF]':
                info.getValue().toLowerCase() === 'unknown',
            })}
            size="sm"
          />
        ),
        header: () => 'Severity',
        minSize: 80,
        size: 80,
        maxSize: 100,
      }),
      columnHelper.accessor('cve_cvss_score', {
        enableResizing: false,
        cell: (info) => info.getValue(),
        header: () => 'Score',
        minSize: 70,
        size: 60,
        maxSize: 85,
      }),
      columnHelper.accessor('cve_attack_vector', {
        enableResizing: false,
        cell: (info) => info.getValue(),
        header: () => 'Attack Vector',
        minSize: 100,
        size: 120,
        maxSize: 250,
      }),
      columnHelper.accessor('has_live_connection', {
        enableResizing: false,
        cell: (info) => (
          <div
            className={cx('h-2.5 w-2.5 rounded-full', {
              'bg-green-400 text:bg-green-500': info.getValue() === true,
              'bg-gray-400 text:bg-gray-500': info.getValue() === false,
            })}
          ></div>
        ),
        header: () => 'Live',
        minSize: 60,
        size: 70,
        maxSize: 70,
      }),
      columnHelper.accessor('exploit_poc', {
        enableSorting: false,
        enableResizing: false,
        cell: (info) => {
          if (!info.getValue().length) return '-';
          return (
            <DFLink href={info.getValue()} target="_blank">
              <IconContext.Provider
                value={{
                  className: 'w-4 h-4',
                }}
              >
                <HiExternalLink />
              </IconContext.Provider>
            </DFLink>
          );
        },
        header: () => 'Exploit',
        minSize: 60,
        size: 60,
        maxSize: 70,
      }),
      columnHelper.accessor('resources', {
        enableSorting: false,
        enableResizing: true,
        cell: (info) => {
          return <TruncatedText text={info.getValue()?.join('\n') ?? ''} />;
        },
        header: () => 'Affected Resources',
        minSize: 180,
        size: 180,
        maxSize: 190,
      }),
      columnHelper.accessor('cve_description', {
        enableSorting: false,
        enableResizing: true,
        cell: (info) => <TruncatedText text={info.getValue() ?? ''} />,
        header: () => 'Description',
        minSize: 200,
        size: 200,
        maxSize: 210,
      }),
    ];

    return columns;
  }, [searchParams]);

  const elementToFocusOnClose = useRef(null);

  const isFilterApplied =
    searchParams.has('severity') || searchParams.has('liveConnection');

  const onResetFilters = () => {
    setSearchParams(() => {
      return {};
    });
  };

  return (
    <div>
      <div className="flex p-2 pl-2 w-full items-center shadow bg-white dark:bg-gray-800">
        <Breadcrumb separator={<HiChevronRight />} transparent>
          <BreadcrumbLink>
            <DFLink to={'/vulnerability'}>Vulnerabilities</DFLink>
          </BreadcrumbLink>
          <BreadcrumbLink>
            <span className="inherit cursor-auto">Most Exploitable Vulnerabilities</span>
          </BreadcrumbLink>
        </Breadcrumb>

        <span className="ml-2 max-h-5 flex items-center">
          {navigation.state === 'loading' ? <CircleSpinner size="xs" /> : null}
        </span>
        <div className="ml-auto flex gap-x-4">
          <div className="relative gap-x-4">
            {isFilterApplied && (
              <span className="absolute -left-[2px] -top-[2px] inline-flex h-2 w-2 rounded-full bg-blue-400 opacity-75"></span>
            )}

            <Popover
              triggerAsChild
              elementToFocusOnCloseRef={elementToFocusOnClose}
              content={
                <div className="dark:text-white">
                  <FilterHeader onReset={onResetFilters} />
                  <Form className="flex flex-col gap-y-4 p-4">
                    <fieldset>
                      <legend className="text-sm font-medium">Severity</legend>
                      <Listbox
                        sizing="sm"
                        name="severity"
                        placeholder="Select Severity"
                        multiple={true}
                        value={searchParams.getAll('severity')}
                        onChange={(value) => {
                          setSearchParams((prev) => {
                            prev.delete('severity');
                            value.forEach((v) => {
                              prev.append('severity', v.toLowerCase());
                            });

                            return prev;
                          });
                        }}
                      >
                        {['critical', 'high', 'medium', 'low', 'unknown'].map((key) => {
                          return (
                            <ListboxOption key={key} value={key}>
                              {capitalize(key)}
                            </ListboxOption>
                          );
                        })}
                      </Listbox>
                    </fieldset>
                    <fieldset>
                      <legend className="text-sm font-medium">Live Connection</legend>
                      <div className="flex gap-x-4 pt-1">
                        <Checkbox
                          label="Active"
                          checked={searchParams
                            .getAll('liveConnection')
                            .includes('active')}
                          onCheckedChange={(state) => {
                            if (state) {
                              setSearchParams((prev) => {
                                prev.append('liveConnection', 'active');

                                return prev;
                              });
                            } else {
                              setSearchParams((prev) => {
                                const prevStatuses = prev.getAll('liveConnection');
                                prev.delete('liveConnection');

                                prevStatuses
                                  .filter((status) => status !== 'active')
                                  .forEach((status) => {
                                    prev.append('liveConnection', status);
                                  });
                                return prev;
                              });
                            }
                          }}
                        />
                        <Checkbox
                          label="Inactive"
                          checked={searchParams
                            .getAll('liveConnection')
                            .includes('inActive')}
                          onCheckedChange={(state) => {
                            if (state) {
                              setSearchParams((prev) => {
                                prev.append('liveConnection', 'inActive');

                                return prev;
                              });
                            } else {
                              setSearchParams((prev) => {
                                const prevStatuses = prev.getAll('liveConnection');
                                prev.delete('liveConnection');
                                prevStatuses
                                  .filter((status) => status !== 'inActive')
                                  .forEach((status) => {
                                    prev.append('liveConnection', status);
                                  });

                                return prev;
                              });
                            }
                          }}
                        />
                      </div>
                    </fieldset>
                  </Form>
                </div>
              }
            >
              <IconButton
                className="ml-auto rounded-lg"
                size="xs"
                outline
                color="primary"
                ref={elementToFocusOnClose}
                icon={<FiFilter />}
              />
            </Popover>
          </div>
        </div>
      </div>
      <div className="m-2">
        <Suspense fallback={<TableSkeleton columns={9} rows={10} size={'md'} />}>
          <DFAwait resolve={loaderData.data}>
            {(resolvedData: LoaderDataType['data']) => {
              return (
                <Table
                  size="sm"
                  data={resolvedData.vulnerabilities ?? []}
                  columns={columns}
                  enablePagination
                  enableRowSelection
                  enableColumnResizing
                  pageSize={PAGE_SIZE}
                  enableSorting
                />
              );
            }}
          </DFAwait>
        </Suspense>
      </div>
      <Outlet />
    </div>
  );
};

export const module = {
  loader,
  element: <MostExploitableVulnerabilities />,
};
