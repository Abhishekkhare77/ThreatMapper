package malwarescan

import (
	"encoding/json"

	"github.com/deepfence/ThreatMapper/deepfence_utils/log"
	"github.com/deepfence/ThreatMapper/deepfence_utils/utils"
	"github.com/twmb/franz-go/pkg/kgo"
)

type MalwareScanStatus struct {
	utils.MalwareScanParameters
	ScanStatus  string `json:"scan_status,omitempty"`
	ScanMessage string `json:"scan_message,omitempty"`
}

func NewMalwareScanStatus(params utils.MalwareScanParameters, Status string, msg string) MalwareScanStatus {
	return MalwareScanStatus{MalwareScanParameters: params, ScanStatus: Status, ScanMessage: msg}
}

func SendScanStatus(ingestC chan *kgo.Record, status MalwareScanStatus, rh []kgo.RecordHeader) error {
	sb, err := json.Marshal(status)
	if err != nil {
		log.Error().Msg(err.Error())
		return err
	} else {
		ingestC <- &kgo.Record{
			Topic:   utils.MALWARE_SCAN_STATUS,
			Value:   sb,
			Headers: rh,
		}
	}
	return nil
}
